/**
 * Report Generator
 * Outputs JSON and Markdown reports
 */

const fs = require('fs');
const path = require('path');
const config = require('../config');

async function generateReport(scoredOpportunities) {
    const timestamp = new Date().toISOString().replace(/:/g, '-').split('.')[0];
    const outputDir = config.paths.output;

    // 1. JSON Dump (Raw Data)
    const jsonPath = path.join(outputDir, `opportunities-${timestamp}.json`);
    fs.writeFileSync(jsonPath, JSON.stringify(scoredOpportunities, null, 2));

    // 2. Markdown Report (Human Readable)
    const topOpportunities = scoredOpportunities.slice(0, 10);

    let md = `# ðŸš€ Market Opportunity Report\n\n`;
    md += `**Generated:** ${new Date().toLocaleString()}\n`;
    md += `**Analyzed:** ${scoredOpportunities.length} potential pain points\n\n`;

    md += `## ðŸ† Top 10 Validated Opportunities\n\n`;

    topOpportunities.forEach((opp, index) => {
        md += `### ${index + 1}. ${opp.title.substring(0, 80)}${opp.title.length > 80 ? '...' : ''}\n\n`;

        md += `**ðŸŽ¯ Score: ${opp.scores.final}/100**\n`;
        md += `- **Product Idea:** ${opp.recommendation}\n`;
        md += `- **Subreddit:** r/${opp.subreddit}\n`;
        md += `- **Source:** [View Discussion](${opp.url})\n\n`;

        md += `| Metric | Status | Details |\n`;
        md += `|--------|--------|---------|\n`;
        md += `| **Demand** | ${opp.trendData.isTrending ? 'ðŸ“ˆ Rising' : 'âž– Stable'} | Growth: ${opp.trendData.trendGrowth}% |\n`;
        md += `| **Competition** | ${opp.scores.competition > 70 ? 'ðŸŸ¢ Low' : opp.scores.competition > 40 ? 'ðŸŸ¡ Medium' : 'ðŸ”´ High'} | Score: ${opp.scores.competition}/100 |\n`;
        md += `| **Pain Level** | ${opp.scores.reddit > 70 ? 'ðŸ”¥ High' : 'ðŸ”¸ Medium'} | Engagement: ${opp.score + opp.comments} |\n\n`;

        md += `**Competition Landscape:**\n`;
        const landscape = opp.serpAnalysis.landscape;
        md += `- Forums on Page 1: ${landscape.forumCount}\n`;
        md += `- Competitor Tools: ${landscape.toolCount}\n`;
        md += `- Top Domain: ${landscape.topDomain}\n\n`;

        md += `**Keywords:** \`${opp.searchQuery}\`\n`;

        md += `\n---\n\n`;
    });

    md += `\n*Generated by Market Research Bot*\n`;

    const mdPath = path.join(outputDir, `opportunities-${timestamp}.md`);
    fs.writeFileSync(mdPath, md);

    // Update 'latest' pointer for easier access
    fs.writeFileSync(path.join(outputDir, 'latest.md'), md);

    return mdPath;
}

module.exports = {
    generateReport
};
